<!--pages/family/family.wxml-->
<view class="container">
  <!-- Header -->
  <view class="header">
    <view class="header-content">
      <text class="title">å®¶åº­ç»„</text>
      <text class="subtitle">ä¸å®¶åº­æˆå‘˜å…±äº«è´¦å•</text>
    </view>
  </view>

  <!-- æœªåŠ å…¥å®¶åº­ç»„ -->
  <view wx:if="{{!familyGroup}}" class="no-family">
    <view class="empty-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</view>
    <view class="empty-title">æ‚¨è¿˜æœªåŠ å…¥ä»»ä½•å®¶åº­ç»„</view>
    <view class="empty-desc">åˆ›å»ºæˆ–åŠ å…¥å®¶åº­ç»„ï¼Œä¸å®¶åº­æˆå‘˜ä¸€èµ·ç®¡ç†è´¢åŠ¡</view>

    <view class="action-buttons">
      <button class="btn-primary" bindtap="showCreateModal">
        <text class="btn-icon">â•</text>
        <text>åˆ›å»ºå®¶åº­ç»„</text>
      </button>
      <button class="btn-secondary" bindtap="showJoinModal">
        <text class="btn-icon">ğŸ”—</text>
        <text>åŠ å…¥å®¶åº­ç»„</text>
      </button>
    </view>
  </view>

  <!-- å·²åŠ å…¥å®¶åº­ç»„ -->
  <view wx:else class="has-family">
    <!-- æ›´å¤šæ“ä½œæŒ‰é’® -->
    <view class="btn-more" bindtap="showActions">Â·Â·Â·</view>

    <!-- å®¶åº­ç»„ä¿¡æ¯ -->
    <view class="family-info">
      <view class="info-header">
        <view class="family-name-wrap">
          <text class="family-name">{{familyGroup.name}}</text>
          <text class="member-count-badge">{{familyGroup.members.length}}ä½æˆå‘˜</text>
        </view>
      </view>

      <view class="invite-section">
        <view class="invite-label">é‚€è¯·ç </view>
        <view class="invite-code-box">
          <text class="invite-code">{{familyGroup.inviteCode}}</text>
          <button class="btn-copy" bindtap="copyInviteCode">
            {{copied ? 'å·²å¤åˆ¶' : 'å¤åˆ¶'}}
          </button>
        </view>
        <view class="invite-desc">åˆ†äº«æ­¤é‚€è¯·ç ç»™å®¶åº­æˆå‘˜</view>
      </view>
    </view>

    <!-- ç»Ÿè®¡æ•°æ® -->
    <view wx:if="{{stats}}" class="stats-section">
      <view class="section-title">è´¢åŠ¡ç»Ÿè®¡</view>

      <view class="stats-cards">
        <!-- ä¸ªäººç»Ÿè®¡ -->
        <view class="stat-card">
          <view class="stat-title">æˆ‘çš„ç»Ÿè®¡</view>
          <view class="stat-item">
            <text class="stat-label">æ€»æ”¶å…¥</text>
            <text class="stat-value income">Â¥{{stats.personalStats.totalIncome}}</text>
          </view>
          <view class="stat-item">
            <text class="stat-label">æ€»æ”¯å‡º</text>
            <text class="stat-value expense">Â¥{{stats.personalStats.totalExpense}}</text>
          </view>
          <view class="stat-item total">
            <text class="stat-label">ä½™é¢</text>
            <text class="stat-value {{stats.personalStats.balance >= 0 ? 'positive' : 'negative'}}">
              Â¥{{stats.personalStats.balance}}
            </text>
          </view>
        </view>

        <!-- å®¶åº­ç»Ÿè®¡ -->
        <view class="stat-card highlight">
          <view class="stat-title">å®¶åº­æ€»è®¡</view>
          <view class="stat-item">
            <text class="stat-label">æ€»æ”¶å…¥</text>
            <text class="stat-value income">Â¥{{stats.familyStats.totalIncome}}</text>
          </view>
          <view class="stat-item">
            <text class="stat-label">æ€»æ”¯å‡º</text>
            <text class="stat-value expense">Â¥{{stats.familyStats.totalExpense}}</text>
          </view>
          <view class="stat-item total">
            <text class="stat-label">ä½™é¢</text>
            <text class="stat-value {{stats.familyStats.balance >= 0 ? 'positive' : 'negative'}}">
              Â¥{{stats.familyStats.balance}}
            </text>
          </view>
        </view>
      </view>

      <!-- æˆå‘˜ç»Ÿè®¡ -->
      <view class="member-stats">
        <view class="member-stats-title">æˆå‘˜ç»Ÿè®¡</view>
        <view class="member-stats-list">
          <view class="member-stat-item" wx:for="{{stats.memberStats}}" wx:key="userId">
            <view class="member-main">
              <view class="member-avatar-small">
                {{item.nickname ? item.nickname[0] : item.username[0]}}
              </view>
              <view class="member-detail-info">
                <view class="member-name-row">
                  <text class="member-stat-name">{{item.nickname || item.username}}</text>
                  <text class="crown" wx:if="{{item.userId === familyGroup.creatorId}}">ğŸ‘‘</text>
                </view>
                <view class="member-transactions">
                  <text class="trans-count">{{item.transactionCount}}ç¬”</text>
                </view>
              </view>
            </view>
            <view class="member-amounts">
              <view class="amount-row">
                <text class="amount-label">æ”¶å…¥</text>
                <text class="amount-value income">Â¥{{item.totalIncome}}</text>
              </view>
              <view class="amount-row">
                <text class="amount-label">æ”¯å‡º</text>
                <text class="amount-value expense">Â¥{{item.totalExpense}}</text>
              </view>
              <view class="amount-row total">
                <text class="amount-label">ä½™é¢</text>
                <text class="amount-value {{item.balance >= 0 ? 'positive' : 'negative'}}">
                  Â¥{{item.balance}}
                </text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆå‘˜åˆ—è¡¨ -->
    <view class="members-section">
      <view class="section-title">å®¶åº­æˆå‘˜ ({{familyGroup.members.length}})</view>
      <view class="member-list">
        <view class="member-item" wx:for="{{familyGroup.members}}" wx:key="user.id">
          <view class="member-avatar">
            {{item.user.nickname ? item.user.nickname[0] : item.user.username[0]}}
          </view>
          <view class="member-detail">
            <view class="member-name-line">
              <text class="member-name">{{item.user.nickname || item.user.username}}</text>
              <text class="crown" wx:if="{{item.role === 'CREATOR'}}">ğŸ‘‘</text>
              <text class="me-tag" wx:if="{{item.user.id === currentUser.id}}">æˆ‘</text>
            </view>
            <view class="member-role">
              <text wx:if="{{item.role === 'CREATOR'}}">åˆ›å»ºè€…</text>
              <text class="join-date">åŠ å…¥äº {{item.joinedAt}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ›å»ºå®¶åº­ç»„å¼¹çª— -->
  <view class="modal {{showCreateDialog ? 'show' : ''}}" bindtap="hideCreateModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">åˆ›å»ºå®¶åº­ç»„</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">å®¶åº­ç»„åç§°</text>
          <input
            class="form-input"
            placeholder="ä¾‹å¦‚ï¼šå¼ å®¶ã€æ¸©é¦¨å°å®¶"
            value="{{groupName}}"
            bindinput="onGroupNameInput"
            maxlength="100"
          />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideCreateModal">å–æ¶ˆ</button>
        <button
          class="btn-confirm"
          bindtap="handleCreateGroup"
          disabled="{{submitting || !groupName}}"
        >
          {{submitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»º'}}
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ å…¥å®¶åº­ç»„å¼¹çª— -->
  <view class="modal {{showJoinDialog ? 'show' : ''}}" bindtap="hideJoinModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">åŠ å…¥å®¶åº­ç»„</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">é‚€è¯·ç </text>
          <input
            class="form-input"
            placeholder="è¯·è¾“å…¥8ä½é‚€è¯·ç "
            value="{{inviteCode}}"
            bindinput="onInviteCodeInput"
            maxlength="8"
          />
          <text class="form-hint">è¯·å‘å®¶åº­æˆå‘˜ç´¢å–é‚€è¯·ç </text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideJoinModal">å–æ¶ˆ</button>
        <button
          class="btn-confirm"
          bindtap="handleJoinGroup"
          disabled="{{submitting || inviteCode.length !== 8}}"
        >
          {{submitting ? 'åŠ å…¥ä¸­...' : 'åŠ å…¥'}}
        </button>
      </view>
    </view>
  </view>

  <!-- æ“ä½œèœå• -->
  <view class="action-sheet {{showActionSheet ? 'show' : ''}}" bindtap="hideActions">
    <view class="action-sheet-content" catchtap="stopPropagation">
      <button
        wx:if="{{familyGroup.creatorId === currentUser.id}}"
        class="action-btn danger"
        bindtap="handleDissolve"
      >
        <text class="action-icon">ğŸ—‘ï¸</text>
        <text>è§£æ•£å®¶åº­ç»„</text>
      </button>
      <button
        wx:else
        class="action-btn"
        bindtap="handleLeave"
      >
        <text class="action-icon">ğŸšª</text>
        <text>é€€å‡ºå®¶åº­ç»„</text>
      </button>
      <button class="action-btn cancel" bindtap="hideActions">å–æ¶ˆ</button>
    </view>
  </view>

  <!-- è¿”å›æŒ‰é’® -->
  <view class="back-nav">
    <navigator open-type="switchTab" url="/pages/index/index" class="back-btn">
      <text class="back-icon">â†</text>
      <text class="back-text">è¿”å›è®°è´¦</text>
    </navigator>
  </view>
</view>
