<view class="container">
  <view class="ai-input-section">
    <view class="input-card">
      <view class="card-header">
        <view class="header-text">
          <text class="section-title">✨ AI智能记账</text>
          <text class="section-subtitle">说话或打字，自动识别金额、分类</text>
        </view>
        <view class="header-actions">
          <view
            class="btn-voice {{recording || recorderStarting ? 'recording' : ''}} {{voiceProcessing ? 'disabled' : ''}}"
            bindtouchstart="startRecording"
            bindtouchend="stopRecording"
            hover-class="btn-voice-hover"
          >
            <text class="btn-icon">🎤</text>
          </view>
          <button
            class="btn-parse {{inputText ? 'active' : ''}}"
            bindtap="onParse"
            loading="{{parsing}}"
            disabled="{{parsing || voiceProcessing || !inputText}}"
          >
            <text class="btn-icon">{{parsing ? '⏳' : '🤖'}}</text>
            <text class="btn-text">{{parsing ? '解析中...' : 'AI解析'}}</text>
          </button>
        </view>
      </view>

      <!-- 录音动画 -->
      <view wx:if="{{recording}}" class="recording-animation">
        <view class="recording-pulse"></view>
        <view class="recording-pulse delay-1"></view>
        <view class="recording-pulse delay-2"></view>
        <text class="recording-text">正在录音...</text>
      </view>

      <!-- 处理中状态 -->
      <view wx:if="{{voiceProcessing}}" class="voice-processing">
        <text class="processing-text">识别中...</text>
      </view>

      <view class="input-wrapper">
        <textarea
          class="ai-input"
          placeholder="例如：今天花了25元买午饭"
          value="{{inputText}}"
          bindinput="onInputChange"
          maxlength="200"
        />
        <text class="char-count">{{inputText.length}}/200</text>
      </view>

      <!-- 识别失败重试按钮 -->
      <view wx:if="{{voiceError && asrText}}" class="voice-error">
        <text class="error-text">已识别：{{asrText}}</text>
        <button class="btn-retry" bindtap="retryVoiceRecognition">
          <text>重试解析</text>
        </button>
      </view>
    </view>
  </view>

  <view class="form-section">
    <view class="form-card">
      <view class="form-header">
        <text class="form-title">{{mode === 'edit' ? '编辑记录' : '记账详情'}}</text>
      </view>

      <view class="form-row">
        <text class="label">交易类型</text>
        <view class="type-selector">
          <view 
            class="type-item {{type === 'EXPENSE' ? 'active expense' : ''}}"
            bindtap="onTypeSelect"
            data-type="EXPENSE"
          >
            <text class="type-text">💰 支出</text>
          </view>
          <view 
            class="type-item {{type === 'INCOME' ? 'active income' : ''}}"
            bindtap="onTypeSelect"
            data-type="INCOME"
          >
            <text class="type-text">💵 收入</text>
          </view>
        </view>
      </view>

      <view class="form-divider"></view>

      <view class="form-row amount-row">
        <text class="label">金额</text>
        <view class="amount-input-wrapper">
          <text class="currency-symbol">¥</text>
          <input 
            class="amount-input" 
            type="digit" 
            placeholder="0.00" 
            value="{{amount}}"
            bindinput="onAmountInput"
          />
        </view>
      </view>

      <view class="form-divider"></view>

      <view class="form-row">
        <text class="label">分类</text>
        <picker 
          mode="selector" 
          range="{{currentCategories}}" 
          bindchange="onCategoryChange"
        >
          <view class="picker-value {{category ? 'selected' : ''}}">
            <text class="picker-icon">{{category ? '📂' : '➕'}}</text>
            <text class="picker-text">{{category || '请选择分类'}}</text>
            <text class="arrow">›</text>
          </view>
        </picker>
      </view>

      <view class="form-divider"></view>

      <view class="form-row">
        <text class="label">日期</text>
        <picker 
          mode="date" 
          value="{{date}}" 
          bindchange="onDateChange"
        >
          <view class="picker-value selected">
            <text class="picker-icon">📅</text>
            <text class="picker-text">{{date}}</text>
            <text class="arrow">›</text>
          </view>
        </picker>
      </view>

      <view class="form-divider"></view>

      <view class="form-row full-width">
        <text class="label">备注</text>
        <view class="textarea-wrapper">
          <textarea 
            class="textarea" 
            placeholder="添加备注（可选）" 
            value="{{description}}"
            bindinput="onDescriptionInput"
            maxlength="100"
          />
          <text class="char-count">{{description.length}}/100</text>
        </view>
      </view>
    </view>
  </view>

  <view class="action-buttons">
    <button class="btn-reset" bindtap="onReset" wx:if="{{mode === 'create'}}">
      <text class="btn-icon">🔄</text>
      <text class="btn-text">重置</text>
    </button>
    <button class="btn-save" bindtap="onSave">
      <text class="btn-icon">💾</text>
      <text class="btn-text">{{mode === 'edit' ? '更新' : '保存'}}</text>
    </button>
  </view>
</view>
