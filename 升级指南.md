# 服务器升级指南

## 概述

本指南提供了两个升级脚本来解决Node.js版本兼容性问题：

1. **upgrade-server.sh** - 完整的服务器环境升级
2. **upgrade-docker-images.sh** - 快速Docker镜像升级

## 使用方法

### 1. 上传脚本到服务器

将以下文件上传到你的Linux服务器：
- `upgrade-server.sh`
- `upgrade-docker-images.sh`
- `setup-scripts.bat` (可选，仅用于参考)

### 2. 设置脚本权限

在Linux服务器上运行：
```bash
chmod +x upgrade-server.sh
chmod +x upgrade-docker-images.sh
chmod +x deploy.sh
chmod +x *.sh
```

### 3. 选择升级方式

#### 方式一：完整升级（推荐首次使用）
```bash
./upgrade-server.sh
```

**功能包括：**
- ✅ 更新系统包管理器
- ✅ 升级所有系统包
- ✅ 安装/升级Docker到最新版本
- ✅ 安装Node.js LTS版本（20.x）
- ✅ 升级npm到最新版本
- ✅ 配置Swap文件（低内存服务器）
- ✅ 优化Docker内存设置
- ✅ 清理系统和Docker缓存
- ✅ 系统重启选项

#### 方式二：快速镜像升级
```bash
./upgrade-docker-images.sh
```

**功能包括：**
- ✅ 停止现有Docker服务
- ✅ 清理旧镜像和容器
- ✅ 拉取最新的Node.js 20和PostgreSQL镜像
- ✅ 清理未使用的镜像
- ✅ 可选择立即部署

### 4. 部署应用

升级完成后，运行部署脚本：
```bash
./deploy.sh
```

## 问题解决

### 如果遇到权限问题：
```bash
sudo chmod +x *.sh
sudo ./upgrade-server.sh
```

### 如果Docker命令需要sudo：
脚本会自动检测并使用sudo权限。

### 如果内存不足：
- 脚本会自动创建Swap文件
- 优化Docker内存使用
- 建议重启服务器释放内存

## 升级前后对比

### 升级前：
- Node.js: v18.20.8 ❌
- Docker镜像: node:18-alpine ❌
- 依赖兼容性: 不兼容 ❌

### 升级后：
- Node.js: v20.x.x ✅
- Docker镜像: node:20-alpine ✅
- 依赖兼容性: 完全兼容 ✅

## 注意事项

1. **备份数据**：升级前建议备份重要数据
2. **重启服务器**：完整升级后建议重启服务器
3. **测试应用**：升级后测试应用功能是否正常
4. **监控资源**：升级后监控内存和CPU使用情况

## 验证升级结果

升级完成后，可以运行以下命令验证：

```bash
# 检查Node.js版本
node --version

# 检查Docker版本
docker --version

# 检查Docker Compose版本
docker compose version

# 检查应用容器中的Node.js版本
docker compose exec app node --version

# 检查内存使用情况
free -h

# 检查Swap使用情况
swapon --show
```

## 故障排除

如果升级后仍有问题：

1. **清理并重新部署**：
   ```bash
   docker compose down --volumes
   docker system prune -af
   ./deploy.sh
   ```

2. **检查日志**：
   ```bash
   docker compose logs app
   docker compose logs postgres
   ```

3. **重启Docker服务**：
   ```bash
   sudo systemctl restart docker
   ```

## 联系支持

如果遇到问题，请提供以下信息：
- 错误日志
- 系统信息 (`uname -a`)
- Docker版本 (`docker --version`)
- 内存使用情况 (`free -h`)