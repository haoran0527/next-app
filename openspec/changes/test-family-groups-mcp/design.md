# Design: Family Groups E2E Testing with Chrome DevTools MCP

## 测试架构

### 测试工具链
- **Chrome DevTools MCP**: 提供浏览器自动化能力
  - 页面导航 (`navigate_page`)
  - 快照抓取 (`take_snapshot`)
  - 元素交互 (`click`, `fill`)
  - JavaScript 执行 (`evaluate_script`)
  - 网络请求监控 (`list_network_requests`)

- **测试运行方式**:
  - 在开发会话中手动执行测试步骤
  - 使用 Claude Code 的 MCP 工具直接与浏览器交互
  - 实时验证每一步的执行结果

### 测试数据管理

#### 测试账号策略
```javascript
const testUsers = [
  {
    username: 'test_family_1',
    email: 'test1@example.com',
    password: 'Test123456',
    nickname: '测试用户1'
  },
  {
    username: 'test_family_2',
    email: 'test2@example.com',
    password: 'Test123456',
    nickname: '测试用户2'
  },
  {
    username: 'test_family_3',
    email: 'test3@example.com',
    password: 'Test123456',
    nickname: '测试用户3'
  }
]
```

#### 数据清理策略
- 每次测试前清理已存在的测试账号
- 使用数据库直接删除或通过 API 清理
- 确保测试的可重复性和独立性

### 测试流程设计

#### 阶段 1: 环境准备
```
1. 启动开发服务器（npm run dev）
2. 打开浏览器并导航到 localhost:3000
3. 清理测试数据（删除已存在的测试账号）
```

#### 阶段 2: 注册测试
```
4. 注册 test_family_1
5. 验证注册成功并自动登录
6. 退出登录
7. 注册 test_family_2
8. 验证注册成功并自动登录
9. 退出登录
10. 注册 test_family_3
11. 验证注册成功并自动登录
```

#### 阶段 3: 创建家庭组
```
12. 以 test_family_1 身份登录
13. 导航到 /dashboard/family-groups
14. 点击"创建家庭组"按钮
15. 输入家庭组名称"测试家庭"
16. 提交创建
17. 验证家庭组创建成功
18. 验证邀请码显示（8位大写字母+数字）
19. 复制邀请码
```

#### 阶段 4: 成员加入
```
20. 退出 test_family_1
21. 以 test_family_2 身份登录
22. 导航到 /dashboard/family-groups
23. 点击"加入家庭组"按钮
24. 粘贴邀请码
25. 提交加入
26. 验证加入成功
27. 验证能看到 test_family_1 是创建者
28. 验证能看到自己（test_family_2）是成员
```

#### 阶段 5: 第三成员加入
```
29. 退出 test_family_2
30. 以 test_family_3 身份登录
31. 导航到 /dashboard/family-groups
32. 重复加入流程
33. 验证能看到所有3个成员
```

#### 阶段 6: 数据访问验证
```
34. test_family_3 创建一些测试交易数据
35. 退出并切换到 test_family_1
36. 验证 test_family_1 能看到 test_family_3 的交易
37. 验证家庭组统计数据正确
38. 验证成员统计列表正确
```

#### 阶段 7: 退出家庭组
```
39. 切换到 test_family_2
40. 点击"退出家庭组"按钮
41. 确认退出
42. 验证退出成功（返回未加入状态）
43. 尝试访问家庭组数据（应该失败）
```

#### 阶段 8: 解散家庭组
```
44. 切换到 test_family_1（创建者）
45. 点击"解散家庭组"按钮
46. 确认解散
47. 验证解散成功
48. 切换到 test_family_3
49. 验证也无法访问家庭组数据
```

#### 阶段 9: 边界条件测试
```
50. test_family_1 尝试创建第二个家庭组（应该失败）
51. test_family_1 尝试使用无效邀请码（应该失败）
52. test_family_2 重新创建家庭组
53. 尝试创建者退出（应该失败）
54. 尝试非创建者解散（应该失败）
```

### 验证点设计

#### 页面快照验证
- 每个关键操作后获取页面快照
- 验证关键文本是否存在（成功/错误消息）
- 验证关键元素是否显示（按钮、输入框等）

#### API 响应验证
- 监控网络请求
- 验证 API 响应状态码（200, 201, 400, 401, 403, 404）
- 验证响应数据结构

#### 数据库状态验证
- 查询数据库验证记录创建
- 验证外键关系正确
- 验证删除操作正确执行

### 问题记录与修复流程

#### 发现问题时
1. 记录问题详情：
   - 重现步骤
   - 期望行为 vs 实际行为
   - 错误消息
   - 页面快照
   - API 响应

2. 分析问题根因：
   - 前端逻辑错误
   - API 实现错误
   - 数据访问控制问题
   - UI/UX 问题

3. 修复问题：
   - 定位到具体文件和代码
   - 实施修复
   - 重新测试验证修复

#### 同步修复小程序端
- Web 端问题修复后
- 检查小程序端是否有相同逻辑
- 如果有，实施相同修复
- 确保两端功能一致性

### 测试报告格式

```markdown
# 家庭组功能测试报告

## 测试环境
- 日期: YYYY-MM-DD
- 测试人员: Claude Code + Chrome DevTools MCP
- 浏览器: Chrome [版本]
- 应用版本: [commit hash]

## 测试结果概览
- 总测试用例: N
- 通过: M
- 失败: K
- 阻塞: L

## 详细测试结果

### 1. 注册流程 ✅/❌
**步骤**: ...
**结果**: ...
**问题**: (如有)

### 2. 创建家庭组 ✅/❌
...

## 发现的问题

### 问题 1: [标题]
**严重程度**: High/Medium/Low
**位置**: [文件:行号]
**描述**: ...
**重现步骤**: 1. ... 2. ...
**修复方案**: ...
**修复状态**: Fixed / Pending / Won't Fix

## 改进建议
1. ...
2. ...

## 测试覆盖率
- 功能覆盖: 100%
- 代码覆盖: [X]%
- 边界条件: [Y]%
```

### 技术挑战与解决方案

#### 挑战 1: 多用户会话管理
**问题**: 测试需要切换多个用户账号
**解决方案**:
- 每次切换前执行完整登出
- 清空 localStorage 和 cookies
- 验证会话完全清除后再登录下一个用户

#### 挑战 2: 异步操作验证
**问题**: API 调用和页面更新是异步的
**解决方案**:
- 使用 `wait_for` 等待特定文本出现
- 设置合理的超时时间
- 轮询检查状态变化

#### 挑战 3: 测试数据隔离
**问题**: 测试数据可能相互干扰
**解决方案**:
- 每次测试前清理数据
- 使用唯一的测试账号名称
- 在独立事务中执行测试（可选）

#### 挑战 4: 微信小程序端测试
**问题**: Chrome DevTools 无法直接测试小程序
**解决方案**:
- 主要测试 Web 端
- 小程序端通过人工验证关键流程
- 代码审查确保两端逻辑一致
- 如需自动化，使用微信开发者工具的自动化接口

### 成功标准

测试被认为成功当：
1. ✅ 所有核心流程测试通过（注册、创建、加入、查看、退出、解散）
2. ✅ 所有边界条件测试通过
3. ✅ 发现的 High 和 Medium 严重程度问题已修复
4. ✅ Web 端和小程序端功能一致
5. ✅ 测试报告完整记录测试过程和结果
6. ✅ 修复后的代码通过 ESLint 和类型检查
